<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
    <style>
      body {
        background-color: #34495E;
      }
      #game-canvas {
        background-color: #2C3E50;
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -40%);
      }
      #error {
        colour: red;
      }
    </style>
  </head>
  <body>
  <canvas id="game-canvas" width="500" height="500">
    <div id="error">Oh no! I can't display the game. Please use a browser that supports HTML5 canvas!</div>
  </canvas>
    <script>
      var canvas = document.getElementById("game-canvas");
      var context = canvas.getContext('2d');
      var squareSize = 20;
      var key;
      var idleCounter = 0;
      var idleTimer = 0;
      var direction = 0;
      var snake, food, changeX, changeY, positionX, positionY, keyReady, rank, score, gameTimer;
      var hi = 0;
      var interval;
      var colourA = "#000";
      var colourB = "#555";
      var snakeColours = ["#1ABC9C",  //turqouise
                          "#2ECC71",  //green
                          "#3498DB",  //blue
                          ];
      var foodColours = [ "#F1C40F",  //yellow
                          "#E67E22",  //orange
                          "#E74C3C", //red
                          ];
      var gameOverBackgroundColor = "#C0392B";
      var gameBackgroundColor = "#2C3E50";
      var gameBackground = document.getElementById('game-canvas');

      var borderColour =  "#34495E";

      var isPlaying = false;
      var gameOver = false;

      var idleKeyStrokes = [37,37,37,37,38,38,38,38,
                            39,39,39,39,40,40,40,40]; // mimic user input before game starts

      var rankNames = ["a", 
                        "be", 
                        "sea", 
                        "lamp", 
                        "dusky", 
                        "planet", 
                        "kitchen", 
                        "shopping", 
                        "timetable",
                        "springtime",
                        "interesting",
                        "happenstance",
                        "imperceptible",
                        "semiconducting",
                        "totalitarianism",
                        "misunderstanding",
                        "spectrophotometer",
                        "transmogrification",
                        "incomprehensibility",
                        "electroencephalogram"];

      setUpGame();

      function setUpGame() {

        document.onkeydown = function (e) {
          if (!isPlaying && !gameOver && handleKey(e.keyCode)) {
            clearInterval(idleTimer);
            startTimer(interval);
            layFood(true);
            isPlaying = true;
          } else if (!isPlaying && gameOver && handleKey(e.keyCode)) {
            setUpGame();
            clearInterval(idleTimer);
            startTimer(interval);
            layFood(true);
            isPlaying = true;
          }
          e = e || window.event;
          key = keyReady ? e.keyCode : 0;
          handleKey(key);
          keyReady = false; // register key press once only
      };

      document.onkeyup = function () {
        keyReady = true;
      }

        clearPlayArea();
        gameBackground.style.background = gameBackgroundColor;
        score = 0;
        rank = 0;
        keyReady = true;
        isPlaying = false;
        gameOver = false;
        positionX = canvas.width/2+(squareSize*2-squareSize/2);   // initial position
        positionY = canvas.height/2+(squareSize-squareSize/2);  // of snake
        changeX = 0;
        changeY = 0;
        direction = 0;
        food = [];
        snake = [{    x: positionX,
                         y: positionY,
                      fill: snakeColours[0],
                    }];

        drawStats();
        interval = 160;
        idleCounter = 0;
        idleTimer = setInterval(idle, interval);
        drawPlayBorder();
        drawSnake();
        for (var i=0; i<2; i++) {
          growSnake();
      }
    }

      function startTimer(interval) {
        gameTimer = setInterval(gameUpdate, interval);
      }

      function idle() {
          clearPlayArea();
          drawStats();
          handleKey(idleKeyStrokes[idleCounter]);
          if (idleCounter < idleKeyStrokes.length-1) {
            idleCounter++;
          } else {
            idleCounter = 0;
          }
          moveSnake();
          drawSnake();
          drawPlayBorder();
      }


      function handleKey(key) {
        // 37 = left
        // 38 = up
        // 39 = right
        // 40 = down
        if (key === 37 && direction !== 'right') {
            setDirection(-squareSize,0);
            direction = 'left';
            return true;
        } else if (key === 38 && direction !== 'down') {
            setDirection(0,-squareSize);
            direction = 'up';
            return true;
        } else if (key === 39 && direction !== 'left') {
            setDirection(squareSize,0);
            direction = 'right';
            return true;
        } else if (key === 40 && direction !== 'up') {
            setDirection(0,squareSize);
            direction = 'down';
            return true;
        }
            return false;
      }

      function setDirection(differenceX, differenceY) {
          var head = snake[0];
          changeX = differenceX;
          changeY = differenceY
          // changeX = differenceX;
          // changeY = differenceY;
      }

      function drawSnake() {
          for (i in snake) {
            context.fillStyle = snake[i].fill;
            context.fillRect(snake[i].x, snake[i].y, squareSize, squareSize);
          }
      }

      function moveSnake(x, y) {

          var head = snake[0];
          head.x += changeX;
          head.y += changeY;

          var i = snake.length-1;
          while ( i > 0 ) {
            var segment = snake[i];
            var x = snake[i-1].x;
            var y = snake[i-1].y;
            segment.x = x;
            segment.y = y;
            i--;
          }
      }

      function growSnake() {
        if (snake.length == 0){
          var x = snake[0].x - squareSize;
          var y = snake[0].y
        } else {
          var lastSegment = snake[snake.length-1];
          var x = lastSegment.x;
          var y = lastSegment.y;
        }

         do {
          var fillColour = pickColour(snakeColours);
        } while (fillColour == lastSegment.fill);

          var newSegment = {   x: x,
                               y: y,
                            fill: fillColour }
          snake.push(newSegment);

      }

      function pickColour(colourArray) {
        var random = Math.floor(Math.random()*snakeColours.length);
        return colourArray[random];
      }

      function layFood(forceLay) {

        var chance = forceLay ? 10 : Math.floor((Math.random() * 10) + 1);

        if (chance == 10) {
          var xGrid = canvas.width/squareSize;
          var yGrid = canvas.height/squareSize;

          var xPos = Math.floor(Math.random() * xGrid + 1)*squareSize;
          var yPos = Math.floor(Math.random() * yGrid + 1)*squareSize;
          
          var head = snake[0];
          if (xPos == head.x && yPos == head.y) layFood(); // check whether new food will intersect snakeColours's position
          for (i in food) {
            if (xPos == food[i].x && yPos == food[i].y) layFood(); // or position of existing food:
          }

          var fill = pickColour(foodColours);

          food.push({x: xPos, y: yPos, fill: fill});
        }
      }

      function drawFood() {
        for (i in food) {
          context.fillStyle = food[i].fill;
          context.fillRect(food[i].x,food[i].y, squareSize, squareSize);
        }
      }

      function clearPlayArea() {
        canvas.width = canvas.width;
      }

      function drawPlayBorder() {
        context.beginPath();
        context.lineWidth=squareSize*2;
        context.strokeStyle=borderColour;
        context.rect(0,0,canvas.width,canvas.height); 
        context.stroke();
      }

      function hasCollidedWithFood() {
        var head = snake[0];

        for (i in food) {
          if (food[i].x === head.x && food[i].y == head.y) {
            food.splice(i,1);
            return true;
          }
        }
      }

      function hasCollidedWithSelfOrEdge() {
        var head = snake[0];

        if (head.y < (0 + squareSize/2) ||
            head.y > (canvas.height - squareSize*1.5)) {
          return true;
        }

       if (head.x < (0 + squareSize/2) ||
            head.x > (canvas.width - squareSize*1.5)) {
          return true;
        }

        for (var i = 2; i < snake.length; i++) {
          if (head.x == snake[i].x && head.y == snake[i].y) return true
        }
      }

      function increaseScore() {
        score +=10;
      }

      function increaseSpeed() {
          clearInterval(gameTimer);
          interval = interval - 5;
          startTimer(interval);
      }

      function drawStats() {

          context.font = "300 20px Lato";
          context.fillStyle = "white";
          var message = "Score: "+score
          message = message.toUpperCase();
          context.fillText(message, 40, 60);
          message = "Hi: "+hi;
          message = message.toUpperCase();
          context.fillText(message, 170, 60);
          message = " Rank: "+rankNames[rank];
          message = message.toUpperCase();
          context.fillText(message, 250, 60);
      }

      function endGame() {
        clearInterval(gameTimer);
            isPlaying = true;
            gameOver = true;
            hi = hi < score ? score : hi;
            gameBackground.style.background = gameOverBackgroundColor;
            setTimeout( function(){
                                  waitForKey();
                                  }, 1000);
      }

      function waitForKey() {
        document.onkeydown = function (e) {
          if (!e) {
            waitForKey();
          } else {
            setUpGame();
          }
      }
    }


      function gameUpdate() {
          canvas.width = canvas.width;
          clearPlayArea();
          layFood();
          moveSnake();
          drawFood();
          if (hasCollidedWithFood()) {
            growSnake();
            increaseScore();
            if (score % 20 === 0) increaseSpeed();
            if (score % 200 == 0) rank++;
          }
          drawSnake();
          drawStats();
          drawPlayBorder();
          if (hasCollidedWithSelfOrEdge()) endGame();

      }
    </script>
  </body>
</html>
